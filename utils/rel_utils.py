import os
import sys
import json
import sqlite3
from array import array
import numpy as np
from ast import literal_eval

sys.path.insert(0, os.path.abspath(os.path.pardir))

RANDOM_SEED = 42
np.random.seed(RANDOM_SEED)


def get_db_emb(path_db, mentions, embtype):
    """
    This function returns the wikipedi2vec embedding for a given
    entity or word. If it is an entity, the prefix "ENTITY/" is
    preappended. If it is a word, the string is lowercased. This
    function opens a connection to the DB, performs the query,
    and closes the connection.

    Arguments:
        path_db: The path to the wikipedia2vec db.
        mentions: The list of words or entitys whose embeddings to extract.
        embtype: A string, either "word", "entity" or "snd". If "word", we
            use wikipedia2vec word embeddings; if "entity, we use wikipedia2vec
            entity embeddings; if "glove", we use glove word embeddings.

    Returns:
        obtained_embedding: A list of arrays (or None) with the embedding.
    """

    results = []
    with sqlite3.connect(path_db) as conn:
        c = conn.cursor()
        for mention in mentions:
            if mention == "#SND/UNK#":
                results.append(
                    [
                        0.22418612241744995,
                        -0.2888180911540985,
                        0.13854354619979858,
                        0.003653974272310734,
                        -0.12870769202709198,
                        0.1024395003914833,
                        0.06162703037261963,
                        0.07317768782377243,
                        -0.06135387346148491,
                        -1.3476412296295166,
                        0.42038747668266296,
                        -0.06359579414129257,
                        -0.09683354943990707,
                        0.1808628886938095,
                        0.2370443195104599,
                        0.014126831665635109,
                        0.17009729146957397,
                        -1.149170160293579,
                        0.31498587131500244,
                        0.06622260808944702,
                        0.024688012897968292,
                        0.07669486105442047,
                        0.13851656019687653,
                        0.021301891654729843,
                        -0.06640639156103134,
                        -0.010336552746593952,
                        0.13523174822330475,
                        -0.0421435683965683,
                        -0.11938712745904922,
                        0.006949146743863821,
                        0.13333013653755188,
                        -0.18276233971118927,
                        0.05238557234406471,
                        0.008943230845034122,
                        -0.2395719736814499,
                        0.08500347286462784,
                        -0.006894187536090612,
                        0.0015865416498854756,
                        0.0633913055062294,
                        0.19177646934986115,
                        -0.1311332881450653,
                        -0.11295504868030548,
                        -0.14277435839176178,
                        0.03413935378193855,
                        -0.03428007662296295,
                        -0.05136607587337494,
                        0.18891511857509613,
                        -0.16673366725444794,
                        -0.05778509005904198,
                        0.036822736263275146,
                        0.08078762888908386,
                        0.022949082776904106,
                        0.03329665586352348,
                        0.011783703230321407,
                        0.05643303319811821,
                        -0.04277614504098892,
                        0.011959478259086609,
                        0.011552747339010239,
                        -0.0007970817969180644,
                        0.11300002783536911,
                        -0.031369760632514954,
                        -0.006155883427709341,
                        -0.009043721482157707,
                        -0.4153434932231903,
                        -0.1887020468711853,
                        0.13708816468715668,
                        0.005911772605031729,
                        -0.11303292959928513,
                        -0.030095556750893593,
                        -0.23909100890159607,
                        -0.05353950336575508,
                        -0.04490499943494797,
                        -0.20228320360183716,
                        0.006564571056514978,
                        -0.09579148888587952,
                        -0.07392080128192902,
                        -0.06487638503313065,
                        0.11173760890960693,
                        -0.04864859580993652,
                        -0.1656530350446701,
                        -0.05203676596283913,
                        -0.07896754145622253,
                        0.13685138523578644,
                        0.0757531225681305,
                        -0.006275638472288847,
                        0.286933034658432,
                        0.5201796293258667,
                        -0.08771556615829468,
                        -0.33010920882225037,
                        -0.13596132397651672,
                        0.11489495635032654,
                        -0.09744380414485931,
                        0.06269526481628418,
                        0.1211867481470108,
                        -0.08026119321584702,
                        0.35256704688072205,
                        -0.06001658737659454,
                        -0.04889918491244316,
                        -0.06828877329826355,
                        0.08874208480119705,
                        0.003964409697800875,
                        -0.0766303762793541,
                        0.12639199197292328,
                        0.0780944675207138,
                        -0.02316400036215782,
                        -0.5680661797523499,
                        -0.03789238631725311,
                        -0.1350950300693512,
                        -0.1135164275765419,
                        -0.11143247038125992,
                        -0.09050163626670837,
                        0.25173333287239075,
                        -0.1484188735485077,
                        0.03463583439588547,
                        -0.07334565371274948,
                        0.06319950520992279,
                        -0.03834318369626999,
                        -0.05413348227739334,
                        0.04219760000705719,
                        -0.09038133174180984,
                        -0.07052794098854065,
                        -0.009173871017992496,
                        0.009069793857634068,
                        0.14051611721515656,
                        0.029582079499959946,
                        -0.03643162176012993,
                        -0.08625560998916626,
                        0.04295022785663605,
                        0.08230835944414139,
                        0.09032970666885376,
                        -0.122795470058918,
                        -0.013900339603424072,
                        0.048119861632585526,
                        0.08678435534238815,
                        -0.14450816810131073,
                        -0.04425004497170448,
                        0.01831969991326332,
                        0.015026411041617393,
                        -0.10052651166915894,
                        0.060212425887584686,
                        0.7405944466590881,
                        -0.0016332970699295402,
                        -0.2496059536933899,
                        -0.023738248273730278,
                        0.01639590971171856,
                        0.11928761750459671,
                        0.13950896263122559,
                        -0.03162425383925438,
                        -0.016450410708785057,
                        0.14079703390598297,
                        -0.0002825950796250254,
                        -0.08052641898393631,
                        -0.0021309524308890104,
                        -0.02535022608935833,
                        0.08693722635507584,
                        0.14308641850948334,
                        0.17146047949790955,
                        -0.13943040370941162,
                        0.04879305139183998,
                        0.09275061637163162,
                        -0.053168028593063354,
                        0.031103068962693214,
                        0.012354841455817223,
                        0.2105841487646103,
                        0.326180636882782,
                        0.18016134202480316,
                        -0.1588113009929657,
                        0.1532336324453354,
                        -0.2255963385105133,
                        -0.04200682416558266,
                        0.008469111286103725,
                        0.038156796246767044,
                        0.1518801897764206,
                        0.13274385035037994,
                        0.11375755816698074,
                        -0.09527557343244553,
                        -0.04948951676487923,
                        -0.10266021639108658,
                        -0.2706456780433655,
                        -0.034566428512334824,
                        -0.018810611218214035,
                        -0.0010361404856666923,
                        0.1034015417098999,
                        0.13883134722709656,
                        0.21130722761154175,
                        -0.019809940829873085,
                        0.1833365559577942,
                        -0.1075163409113884,
                        -0.031288985162973404,
                        0.025182928889989853,
                        0.23233027756214142,
                        0.04205196723341942,
                        0.11731827259063721,
                        -0.1550654172897339,
                        0.006358014885336161,
                        -0.1542990356683731,
                        0.15116986632347107,
                        0.1274585872888565,
                        0.2576863467693329,
                        -0.2548536956310272,
                        -0.07094422727823257,
                        0.1798371523618698,
                        0.054028209298849106,
                        -0.09884487092494965,
                        -0.24594978988170624,
                        -0.09302578866481781,
                        -0.0282035730779171,
                        0.09439938515424728,
                        0.09234027564525604,
                        0.029291663318872452,
                        0.13110609352588654,
                        0.15683098137378693,
                        -0.016919273883104324,
                        0.2392807900905609,
                        -0.13432978093624115,
                        -0.22422641515731812,
                        0.14635199308395386,
                        -0.06499607861042023,
                        0.47036460041999817,
                        -0.02718997374176979,
                        0.06224842369556427,
                        -0.091361865401268,
                        0.2148997038602829,
                        -0.1956244260072708,
                        -0.10032516717910767,
                        -0.09057068079710007,
                        -0.06203768402338028,
                        -0.18876813352108002,
                        -0.10963419079780579,
                        -0.2773522734642029,
                        0.12616299092769623,
                        -0.022179925814270973,
                        -0.16058781743049622,
                        -0.08047454059123993,
                        0.02695314772427082,
                        0.11073178797960281,
                        0.014894072897732258,
                        0.09416890144348145,
                        0.14300113916397095,
                        -0.15940159559249878,
                        -0.06608017534017563,
                        -0.00799551047384739,
                        -0.11668665707111359,
                        -0.13081924617290497,
                        -0.09237651526927948,
                        0.14741156995296478,
                        0.09180161356925964,
                        0.08173615485429764,
                        0.3211158215999603,
                        -0.003655310021713376,
                        -0.047031477093696594,
                        -0.0231179092079401,
                        0.04896119236946106,
                        0.08670001477003098,
                        -0.06766346096992493,
                        -0.5002856850624084,
                        -0.048514630645513535,
                        0.14144542813301086,
                        -0.032995156943798065,
                        -0.11954562366008759,
                        -0.14929790794849396,
                        -0.23883464932441711,
                        -0.01988416351377964,
                        -0.15917156636714935,
                        -0.05208408087491989,
                        0.28009915351867676,
                        -0.002912110649049282,
                        -0.05458146706223488,
                        -0.4738474488258362,
                        0.17112277448177338,
                        -0.12066954374313354,
                        -0.04217442497611046,
                        0.13953189551830292,
                        0.26114872097969055,
                        0.012869438156485558,
                        0.009291584603488445,
                        -0.0026459486689418554,
                        -0.07533072680234909,
                        0.01784074306488037,
                        -0.268696129322052,
                        -0.2181970775127411,
                        -0.17085029184818268,
                        -0.1022816002368927,
                        -0.05528995394706726,
                        0.1351441740989685,
                        0.12362551689147949,
                        -0.10980717837810516,
                        0.13980041444301605,
                        -0.20233899354934692,
                        0.08813502639532089,
                        0.3849637806415558,
                        -0.10653764754533768,
                        -0.061995673924684525,
                        0.028849434107542038,
                        0.032302480190992355,
                        0.02385602705180645,
                        0.06994965672492981,
                        0.19310516119003296,
                        -0.07767657190561295,
                        -0.14481587707996368,
                    ]
                )
            if mention == "#ENTITY/UNK#":
                results.append(
                    [
                        -0.04076816886663437,
                        -0.05368487536907196,
                        -0.011146873235702515,
                        0.07948696613311768,
                        0.09577085077762604,
                        0.05834313482046127,
                        0.10762672871351242,
                        0.02133651077747345,
                        0.06762358546257019,
                        0.10364535450935364,
                        -0.004560213536024094,
                        0.019604451954364777,
                        0.15169470012187958,
                        -0.13691705465316772,
                        0.15249013900756836,
                        -0.021905094385147095,
                        0.028300775215029716,
                        0.03471458703279495,
                        -0.06272316724061966,
                        0.046275295317173004,
                        -0.072679303586483,
                        0.04530569911003113,
                        0.014378506690263748,
                        -0.026582155376672745,
                        0.08046922087669373,
                        0.036571282893419266,
                        -0.05283953994512558,
                        0.16248422861099243,
                        0.051359787583351135,
                        0.027356524020433426,
                        -0.018224239349365234,
                        0.25751596689224243,
                        -0.048705700784921646,
                        -0.0720885768532753,
                        -0.04701745882630348,
                        -0.04094899818301201,
                        0.08843699842691422,
                        0.14340253174304962,
                        -0.08390524983406067,
                        -0.06255713850259781,
                        0.07067577540874481,
                        0.0362575501203537,
                        -0.1650751680135727,
                        -0.10019631683826447,
                        0.035560935735702515,
                        -0.038341909646987915,
                        0.04537946730852127,
                        -0.09539087861776352,
                        -0.002572009339928627,
                        0.0319070890545845,
                        -0.07328589260578156,
                        -0.028194136917591095,
                        -0.05980370193719864,
                        -0.08771291375160217,
                        0.008019519969820976,
                        -0.06439010798931122,
                        -0.01767832413315773,
                        0.048261500895023346,
                        -0.1617475152015686,
                        -0.13621263206005096,
                        0.024381401017308235,
                        -0.09337546676397324,
                        0.08506425470113754,
                        -0.02063252590596676,
                        -0.08747374266386032,
                        -0.021462924778461456,
                        -0.05649912357330322,
                        0.032055288553237915,
                        -0.004934750963002443,
                        0.04185096174478531,
                        -0.0325535424053669,
                        0.01726531982421875,
                        -0.15542519092559814,
                        -0.034990500658750534,
                        -0.07184124737977982,
                        0.08113186061382294,
                        0.026373926550149918,
                        0.0035738684237003326,
                        0.11142178624868393,
                        0.10157475620508194,
                        -0.05904671549797058,
                        -0.0582730807363987,
                        0.11135098338127136,
                        -0.2182699292898178,
                        0.011291422881186008,
                        0.13407666981220245,
                        -0.04548807814717293,
                        -0.11559879779815674,
                        -0.025034340098500252,
                        -0.12469647079706192,
                        0.11134941875934601,
                        -0.03338625282049179,
                        -0.06272423267364502,
                        0.06120537966489792,
                        -0.0073115467093884945,
                        0.12597167491912842,
                        -0.16681678593158722,
                        -0.09297752380371094,
                        -0.006015568505972624,
                        -0.02929729036986828,
                        0.10701856762170792,
                        -0.06297285109758377,
                        -0.07456839829683304,
                        0.10484705865383148,
                        -0.023418091237545013,
                        -0.12244554609060287,
                        -0.11623051017522812,
                        0.2434745877981186,
                        -0.04055582359433174,
                        0.05003004148602486,
                        0.14538906514644623,
                        0.05147343873977661,
                        0.12887388467788696,
                        -0.053697049617767334,
                        -0.11462751030921936,
                        -0.04211489483714104,
                        -0.06359204649925232,
                        0.01975225657224655,
                        -0.034599460661411285,
                        0.035662692040205,
                        0.08109871298074722,
                        -0.02160351723432541,
                        -0.037280429154634476,
                        -0.0013634804636240005,
                        0.0524994358420372,
                        0.0005085078300908208,
                        0.1395675092935562,
                        -0.04098879173398018,
                        -0.020575163885951042,
                        -0.06905369460582733,
                        0.11842717975378036,
                        0.05019186809659004,
                        -0.04048756882548332,
                        -0.014122720807790756,
                        0.06786591559648514,
                        -0.03495313972234726,
                        -0.017302552238106728,
                        -0.029840700328350067,
                        -0.03481968864798546,
                        0.10097909718751907,
                        0.03993922844529152,
                        -0.06569904088973999,
                        -0.037358928471803665,
                        0.05261615291237831,
                        0.011341895908117294,
                        0.003771908348426223,
                        0.04919382557272911,
                        0.031168168410658836,
                        -0.01627730019390583,
                        -0.04664425179362297,
                        0.011936640366911888,
                        -0.12099407613277435,
                        -0.007090836763381958,
                        -0.1159074604511261,
                        0.07130850106477737,
                        -0.06441787630319595,
                        0.06601071357727051,
                        0.038520775735378265,
                        0.07511738687753677,
                        0.09235529601573944,
                        -0.01791664958000183,
                        0.01410115696489811,
                        0.03672743961215019,
                        -0.1021319180727005,
                        -0.0020240379963070154,
                        -0.06189001351594925,
                        -0.0861462950706482,
                        0.023808486759662628,
                        0.033907342702150345,
                        0.039309535175561905,
                        -0.08717194199562073,
                        -0.09433826804161072,
                        -0.020814865827560425,
                        0.0573158822953701,
                        -0.010794645175337791,
                        -0.054263047873973846,
                        -0.005022237543016672,
                        -0.09044622629880905,
                        0.10696545988321304,
                        -0.029783125966787338,
                        0.013617545366287231,
                        -0.12485861778259277,
                        0.10843658447265625,
                        0.13217385113239288,
                        -0.08690521121025085,
                        -0.04482032731175423,
                        -0.03840641304850578,
                        0.007868578657507896,
                        -0.03058399073779583,
                        -0.030069058761000633,
                        -0.12356068938970566,
                        -0.06744937598705292,
                        -0.029728490859270096,
                        0.03721211478114128,
                        0.0008859960362315178,
                        -0.08447415381669998,
                        -0.10226137936115265,
                        -0.06527775526046753,
                        0.0782996341586113,
                        0.07770927995443344,
                        -0.05388261377811432,
                        0.0893377885222435,
                        0.14470036327838898,
                        0.08965712785720825,
                        -0.04972345009446144,
                        0.018818804994225502,
                        0.002572620753198862,
                        0.04612795636057854,
                        -0.11119507253170013,
                        0.004710465203970671,
                        0.03195185214281082,
                        0.12708276510238647,
                        -0.04422695189714432,
                        -0.0054554506205022335,
                        -0.028817087411880493,
                        -0.059297312051057816,
                        -0.12491077184677124,
                        0.09843645244836807,
                        -0.068363718688488,
                        0.015428570099174976,
                        0.052477531135082245,
                        -0.008148238062858582,
                        -0.0865214392542839,
                        -0.09278152883052826,
                        -0.09059599786996841,
                        0.01079247985035181,
                        -0.007575513795018196,
                        0.05509129911661148,
                        -0.253289133310318,
                        -0.014339982531964779,
                        0.07041806727647781,
                        -0.04006600379943848,
                        -0.03018397092819214,
                        0.18447545170783997,
                        -0.27752405405044556,
                        -0.0632937029004097,
                        0.2738836109638214,
                        -0.018556395545601845,
                        0.11937185376882553,
                        -0.0030473903752863407,
                        -0.030760420486330986,
                        0.08298423886299133,
                        -0.04382763430476189,
                        -0.0222726222127676,
                        0.10685846954584122,
                        -0.1453530639410019,
                        -0.04447859153151512,
                        0.058163370937108994,
                        0.09961795806884766,
                        -0.020106932148337364,
                        0.007294514216482639,
                        0.03901796415448189,
                        -0.020193936303257942,
                        -0.0045442297123372555,
                        0.08247783035039902,
                        0.03439200296998024,
                        0.035179995000362396,
                        0.011062684468925,
                        -0.020075585693120956,
                        0.05135892704129219,
                        -0.08533519506454468,
                        -0.17389552295207977,
                        -0.010709289461374283,
                        0.015337441116571426,
                        -0.06875697523355484,
                        0.001817316166125238,
                        -0.025871241465210915,
                        0.05452321842312813,
                        -0.06548111885786057,
                        0.060123857110738754,
                        0.00944817066192627,
                        0.01882716827094555,
                        -0.09817775338888168,
                        0.05276735872030258,
                        -0.011940771713852882,
                        0.07537684589624405,
                        -0.030519573017954826,
                        -0.18105824291706085,
                        -0.11473256349563599,
                        -0.04586024582386017,
                        -0.0966680571436882,
                        0.06422947347164154,
                        0.027082595974206924,
                        -0.09426546096801758,
                        -0.0799640491604805,
                        -0.1129152700304985,
                        -0.025445539504289627,
                        -0.1707836538553238,
                        -0.03004794754087925,
                        -0.1406049281358719,
                        -0.08218180388212204,
                        -0.032309215515851974,
                        -0.15904518961906433,
                        0.04004870355129242,
                        0.049623895436525345,
                        0.0054669929668307304,
                        0.004466346465051174,
                        -0.22897416353225708,
                        0.06953616440296173,
                        -0.06715741008520126,
                    ]
                )
            if mention == "#WORD/UNK#":
                results.append(
                    [
                        -0.08770988881587982,
                        -0.0677553042769432,
                        -0.026013614609837532,
                        0.10760530829429626,
                        0.12111268937587738,
                        0.04554020240902901,
                        0.004365151282399893,
                        0.009454727172851562,
                        0.07652921974658966,
                        0.15346769988536835,
                        0.03054070472717285,
                        -0.013068282045423985,
                        0.14732998609542847,
                        -0.15882128477096558,
                        0.17553214728832245,
                        -0.05021077021956444,
                        0.00938417948782444,
                        0.00034525658702477813,
                        -0.10418792068958282,
                        0.07017731666564941,
                        -0.07784195244312286,
                        0.02544557861983776,
                        0.05699576437473297,
                        -0.03383292257785797,
                        0.06602628529071808,
                        0.07680792361497879,
                        0.013163874857127666,
                        0.15667591989040375,
                        0.06835868954658508,
                        0.06275943666696548,
                        -0.05202621966600418,
                        0.25975462794303894,
                        -0.024471813812851906,
                        -0.09027963876724243,
                        -0.067332424223423,
                        -0.101817786693573,
                        0.07934106141328812,
                        0.16806252300739288,
                        -0.09880445897579193,
                        -0.031790222972631454,
                        0.12011682987213135,
                        0.008500796742737293,
                        -0.16212868690490723,
                        -0.10368283838033676,
                        0.10837492346763611,
                        -0.03877983242273331,
                        0.07157979905605316,
                        -0.08234935998916626,
                        0.044298045337200165,
                        0.059517815709114075,
                        -0.103253073990345,
                        -0.01855071820318699,
                        -0.07682862132787704,
                        -0.0729694589972496,
                        0.020785242319107056,
                        -0.04512545093894005,
                        -0.049338869750499725,
                        0.06954270601272583,
                        -0.19329938292503357,
                        -0.14552636444568634,
                        0.03429018706083298,
                        -0.1383277326822281,
                        0.0731833353638649,
                        -0.003990272991359234,
                        -0.10741577297449112,
                        0.016097867861390114,
                        -0.07864466309547424,
                        -0.0013260431587696075,
                        0.014636969193816185,
                        -0.007961306720972061,
                        -0.07795555889606476,
                        0.026243653148412704,
                        -0.17233172059059143,
                        -0.03765492886304855,
                        -0.07045301795005798,
                        0.08613155782222748,
                        0.03522850200533867,
                        0.008652080781757832,
                        0.17860496044158936,
                        0.08584652096033096,
                        -0.018129704520106316,
                        -0.06667260080575943,
                        0.13807770609855652,
                        -0.21966034173965454,
                        0.03629639372229576,
                        0.14888642728328705,
                        -0.030891912057995796,
                        -0.14189325273036957,
                        -0.0228849109262228,
                        -0.12624911963939667,
                        0.1189417690038681,
                        -0.03297169879078865,
                        -0.12401317805051804,
                        0.09445610642433167,
                        0.05232597887516022,
                        0.1607063114643097,
                        -0.17696700990200043,
                        -0.05090603977441788,
                        -0.054183539003133774,
                        -0.03762991726398468,
                        0.044425103813409805,
                        -0.07520526647567749,
                        -0.06969393789768219,
                        0.09205326437950134,
                        -0.04176342114806175,
                        -0.13488805294036865,
                        -0.13494873046875,
                        0.32541242241859436,
                        -0.03385815769433975,
                        0.046652086079120636,
                        0.1341586410999298,
                        0.015774371102452278,
                        0.11648061871528625,
                        -0.07267910242080688,
                        -0.1174466460943222,
                        -0.005230479408055544,
                        -0.12092835456132889,
                        0.022905118763446808,
                        -0.09616104513406754,
                        0.09549446403980255,
                        0.07466301321983337,
                        -0.032479312270879745,
                        -0.07261152565479279,
                        0.06912745535373688,
                        0.034502364695072174,
                        -0.01593773625791073,
                        0.17566576600074768,
                        0.030009429901838303,
                        0.04333079606294632,
                        -0.07067497074604034,
                        0.08088305592536926,
                        0.08943165838718414,
                        -0.03762490674853325,
                        -0.041247520595788956,
                        0.07223476469516754,
                        -0.042294085025787354,
                        0.03206056356430054,
                        -0.09072015434503555,
                        -0.061311326920986176,
                        0.09381286799907684,
                        0.01177119743078947,
                        -0.11829333007335663,
                        -0.055660273879766464,
                        0.056129090487957,
                        -0.011370937339961529,
                        -0.0332036018371582,
                        0.017354020848870277,
                        0.01848669722676277,
                        0.004594762343913317,
                        -0.03213608264923096,
                        -0.020000828430056572,
                        -0.0977364256978035,
                        -0.008006392978131771,
                        -0.07623475044965744,
                        0.060643188655376434,
                        -0.07092215865850449,
                        0.07582835108041763,
                        0.0733879953622818,
                        0.12016713619232178,
                        0.07048463076353073,
                        -0.04043205454945564,
                        -0.018940145149827003,
                        -0.005992789287120104,
                        -0.1307900846004486,
                        0.005876919254660606,
                        -0.035000208765268326,
                        -0.11207427084445953,
                        0.061607349663972855,
                        0.022781746461987495,
                        0.04797893762588501,
                        -0.1473027914762497,
                        -0.07139560580253601,
                        -0.010076714679598808,
                        0.03861114755272865,
                        0.00136361934710294,
                        -0.050255369395017624,
                        -0.0032816503662616014,
                        -0.12649275362491608,
                        0.13320618867874146,
                        -0.0626831203699112,
                        0.04828764125704765,
                        -0.21073028445243835,
                        0.1421755999326706,
                        0.14951367676258087,
                        -0.11002518236637115,
                        0.004006248898804188,
                        -0.041065558791160583,
                        0.009221305139362812,
                        -0.01880136877298355,
                        -0.006644347682595253,
                        -0.1717606782913208,
                        -0.038641564548015594,
                        -0.050654031336307526,
                        0.05453503131866455,
                        0.033237308263778687,
                        -0.17220807075500488,
                        -0.13995443284511566,
                        -0.07539188861846924,
                        0.04616484418511391,
                        0.07316605746746063,
                        -0.0859924778342247,
                        0.09464041143655777,
                        0.13907422125339508,
                        0.03151232376694679,
                        -0.0496402382850647,
                        -0.0035275088157504797,
                        -0.0013682519784197211,
                        0.08007163554430008,
                        -0.10431340336799622,
                        -0.015047614462673664,
                        0.012855008244514465,
                        0.12474413216114044,
                        -0.04630091413855553,
                        0.02350502274930477,
                        -0.020287562161684036,
                        -0.09616666287183762,
                        -0.0899488776922226,
                        0.06509163975715637,
                        -0.11700990051031113,
                        0.022572195157408714,
                        0.05477593466639519,
                        0.01859358139336109,
                        -0.1297086775302887,
                        -0.1017322987318039,
                        -0.06971600651741028,
                        0.042979586869478226,
                        -0.011284337379038334,
                        0.032149605453014374,
                        -0.28456953167915344,
                        -0.06157643347978592,
                        0.11502957344055176,
                        -0.010230313055217266,
                        -0.006682223174721003,
                        0.18520942330360413,
                        -0.3064548075199127,
                        -0.04750857874751091,
                        0.3178757429122925,
                        -0.019622882828116417,
                        0.13749031722545624,
                        -0.022101255133748055,
                        -0.05799855664372444,
                        0.13215602934360504,
                        -0.07851787656545639,
                        -0.0567903108894825,
                        0.07381048053503036,
                        -0.18002483248710632,
                        -0.03996846452355385,
                        0.09719425439834595,
                        0.09761100262403488,
                        0.004860248416662216,
                        0.07570071518421173,
                        0.024628140032291412,
                        -0.017576970160007477,
                        -0.04570893198251724,
                        0.07795644551515579,
                        0.07479923963546753,
                        0.030169274657964706,
                        0.02167581208050251,
                        0.001705701695755124,
                        0.05573718994855881,
                        -0.1247589960694313,
                        -0.2158881276845932,
                        -0.02040345035493374,
                        -0.018093697726726532,
                        -0.07659505307674408,
                        -0.014306867495179176,
                        -0.07696223258972168,
                        0.09409549087285995,
                        -0.03366706147789955,
                        0.043571438640356064,
                        -0.031214594841003418,
                        -0.036038707941770554,
                        -0.08703774213790894,
                        0.041128650307655334,
                        0.0017293432028964162,
                        0.09084765613079071,
                        -0.06261909008026123,
                        -0.20726794004440308,
                        -0.13386675715446472,
                        -0.012921099551022053,
                        -0.06659729778766632,
                        0.021667638793587685,
                        0.0473274290561676,
                        -0.06981498003005981,
                        -0.10147988796234131,
                        -0.1225065141916275,
                        -0.020017363131046295,
                        -0.13860921561717987,
                        -0.0053115603514015675,
                        -0.1484856903553009,
                        -0.09914736449718475,
                        -0.00535218371078372,
                        -0.1726744920015335,
                        0.01771160401403904,
                        -0.022053666412830353,
                        0.03048780933022499,
                        0.008129318244755268,
                        -0.21168860793113708,
                        0.08295495063066483,
                        -0.02514040470123291,
                    ]
                )
            else:
                result = None
                # Preprocess the mention depending on which embedding to obtain:
                if embtype == "entity":
                    mention = "ENTITY/" + mention
                    result = c.execute(
                        "SELECT emb FROM entity_embeddings WHERE word=?", (mention,)
                    ).fetchone()
                if embtype == "word":
                    mention = mention.lower()
                    result = c.execute(
                        "SELECT emb FROM entity_embeddings WHERE word=?", (mention,)
                    ).fetchone()
                if embtype == "snd":
                    mention = mention
                    result = c.execute(
                        "SELECT emb FROM glove_embeddings WHERE word=?", (mention,)
                    ).fetchone()
                # Get the embeddings from the db:
                results.append(
                    result if result is None else array("f", result[0]).tolist()
                )

    return results


def eval_with_exception(str2parse, in_case=""):
    """
    Given a string in the form or a list or dictionary, parse it
    to read it as such.

    Arguments:
        str2parse (str): the string to parse.
        in_case (str): what should be returned in case of error.
    """
    try:
        return literal_eval(str2parse)
    except ValueError:
        return in_case


def prepare_initial_data(df, context_len=100):
    """
    This function takes a dataframe (as processed by the
    experiments/prepare_data.py script) and generates the
    equivalent json needed to train a REL model.

    Args:
        df: The dataframe containing the linking training data.
        context_len: The maximum number of words in the left
            and right contexts of the sentence where the target
            mention is.

    Returns:
        dict_mentions: a dictionary in which the article id is the
            key, and whose values are a list of dictionaries, each
            containing information about a mention. At this point,
            the mention dictionaries do not yet have the "gold"
            field (the gold standard Wikipedia title) or the selected
            candidates.
    """
    dict_mentions = dict()
    for i, row in df.iterrows():
        article_id = str(row["article_id"])
        dict_sentences = dict()
        for s in eval_with_exception(row["sentences"]):
            dict_sentences[int(s["sentence_pos"])] = s["sentence_text"]

        # Build a mention dictionary per mention:
        for df_mention in eval_with_exception(row["annotations"]):
            dict_mention = dict()
            mention = df_mention["mention"]
            sent_idx = int(df_mention["sent_pos"])

            # Generate left-hand context:
            left_context = ""
            if sent_idx - 1 in dict_sentences:
                left_context = dict_sentences[sent_idx - 1]
            for i in range(sent_idx - 2, 0, -1):
                tmp_context = dict_sentences[i] + " " + left_context
                if len(tmp_context.split(" ")) < context_len:
                    left_context = tmp_context
                else:
                    break

            # Generate right-hand context:
            right_context = ""
            if sent_idx + 1 in dict_sentences:
                right_context = dict_sentences[sent_idx + 1]
            for i in range(sent_idx + 2, len(dict_sentences) + 1):
                tmp_context = right_context + " " + dict_sentences[i]
                if len(tmp_context.split(" ")) < context_len:
                    right_context = tmp_context
                else:
                    break

            dict_mention["mention"] = df_mention["mention"]
            dict_mention["sent_idx"] = sent_idx
            dict_mention["sentence"] = dict_sentences[sent_idx]
            dict_mention["ngram"] = mention
            dict_mention["context"] = [left_context, right_context]
            dict_mention["pos"] = df_mention["mention_start"]
            dict_mention["end_pos"] = df_mention["mention_end"]
            dict_mention["place"] = row["place"]
            dict_mention["place_wqid"] = row["place_wqid"]
            dict_mention["candidates"] = []
            dict_mention["ner_label"] = df_mention["entity_type"]

            # Check this:
            dict_mention["gold"] = [df_mention["wkdt_qid"]]
            if not df_mention["wkdt_qid"].startswith("Q"):
                dict_mention["gold"] = "NIL"

            if article_id in dict_mentions:
                dict_mentions[article_id].append(dict_mention)
            else:
                dict_mentions[article_id] = [dict_mention]

    return dict_mentions


def rank_candidates(rel_json, wk_cands, mentions_to_wikidata):
    new_json = dict()
    for article in rel_json:
        new_json[article] = []
        for mention_dict in rel_json[article]:
            cands = []
            tmp_cands = []
            max_cand_freq = 0
            ranker_cands = wk_cands[mention_dict["mention"]]
            for c in ranker_cands:
                # DeezyMatch confidence score (cosine similarity):
                cand_selection_score = ranker_cands[c]["Score"]
                # For each Wikidata candidate:
                for qc in ranker_cands[c]["Candidates"]:
                    # Mention-to-wikidata absolute relevance:
                    qcrlv_score = mentions_to_wikidata[c][qc]
                    if qcrlv_score > max_cand_freq:
                        max_cand_freq = qcrlv_score
                    # Normalized mention-to-wikidata relevance score:
                    qcm2w_score = ranker_cands[c]["Candidates"][qc]
                    # Average of CS conf score and mention2wiki norm relv:
                    # if cand_selection_score:
                    #     qcm2w_score = (qcm2w_score + cand_selection_score) / 2
                    tmp_cands.append(
                        (qc, qcrlv_score, qcm2w_score, cand_selection_score)
                    )
            # Append candidate and normalized score weighted by candidate selection conf:
            for cand in tmp_cands:
                qc_id = cand[0]
                # Normalize absolute mention-to-wikidata relevance by entity:
                qc_score_1 = round(cand[1] / max_cand_freq, 3)
                # Same as qcm2w_score: normalized mention-to-wikidata relevance by mention:
                qc_score_2 = round(cand[2], 3)
                # DeezyMatch cosine similarity:
                qc_score_3 = cand_selection_score
                # Averaged relevances:
                qc_score = (qc_score_1 + qc_score_2 + qc_score_3) / 3
                cands.append([qc_id, qc_score])
            # Sort candidates and normalize between 0 and 1, and so they add up to 1.
            cands = sorted(cands, key=lambda x: (x[1], x[0]), reverse=True)

            mention_dict["candidates"] = cands
            new_json[article].append(mention_dict)
    return new_json


def add_publication(rel_json):
    """
    TO DO.
    """
    return rel_json


def prepare_rel_trainset(df, mylinker, myranker, dsplit):
    """
    This function takes as input the data prepared for linking, plus
    a Linking and Ranking objects. It prepares the data in the format
    that is required to train and test a REL disambiguation model,
    using the candidates from our ranker.

    Arguments:
        df: a pandas dataframe containing the dataset generated in
            the `experiments/prepare_data.py` script.
        mylinker: a Linking object.
        myranker: a Ranking object.

    This function stores the dataset formatted as a json.
    """
    rel_json = prepare_initial_data(df, mylinker.rel_params["context_length"])

    # Get unique mentions, to run them through the ranker:
    all_mentions = []
    for article in rel_json:
        all_mentions += [y["mention"] for y in rel_json[article]]
    all_mentions = list(set(all_mentions))
    # Format the mentions are required by the ranker:
    all_mentions = [{"mention": mention} for mention in all_mentions]
    # Use the ranker to find candidates:
    wk_cands, myranker.already_collected_cands = myranker.find_candidates(all_mentions)
    # Rank the candidates:
    rel_json = rank_candidates(
        rel_json,
        wk_cands,
        mylinker.linking_resources["mentions_to_wikidata"],
    )
    # # If "publ" is taken into account for the disambiguation, add the place
    # # of publication as an additional already disambiguated entity per row:
    # if mylinker.rel_params["with_publication"] == True:
    #     rel_json = add_publication(rel_json)

    ## TO DO
    with open(
        os.path.join(mylinker.rel_params["data_path"], "rel_{}.json").format(dsplit),
        "w",
    ) as f:
        json.dump(rel_json, f)

    return rel_json
