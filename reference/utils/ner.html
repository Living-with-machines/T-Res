<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>utils.ner module &mdash; T-Res 0.1.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="utils.preprocess_data module" href="preprocess_data.html" />
    <link rel="prev" title="utils.get_data module" href="get_data.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> T-Res
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.html">Getting started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../geoparser/index.html"><code class="docutils literal notranslate"><span class="pre">geoparser</span></code> module</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html"><code class="docutils literal notranslate"><span class="pre">utils</span></code> module</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="deezy_processing.html"><code class="docutils literal notranslate"><span class="pre">utils.deezy_processing</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="get_data.html"><code class="docutils literal notranslate"><span class="pre">utils.get_data</span></code> module</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#"><code class="docutils literal notranslate"><span class="pre">utils.ner</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="preprocess_data.html"><code class="docutils literal notranslate"><span class="pre">utils.preprocess_data</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="process_data.html"><code class="docutils literal notranslate"><span class="pre">utils.process_data</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="process_wikipedia.html"><code class="docutils literal notranslate"><span class="pre">utils.process_wikipedia</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="rel_e2e.html"><code class="docutils literal notranslate"><span class="pre">utils.rel_e2e</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="rel_utils.html"><code class="docutils literal notranslate"><span class="pre">utils.rel_utils</span></code> module</a></li>
<li class="toctree-l3"><a class="reference internal" href="rel/index.html"><code class="docutils literal notranslate"><span class="pre">utils.REL</span></code> module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../t-res-api/index.html">Running T-Res as API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other-files/index.html">Other files in repository</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">T-Res</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Reference</a> &raquo;</li>
          <li><a href="index.html"><code class="docutils literal notranslate"><span class="pre">utils</span></code> module</a> &raquo;</li>
      <li><code class="docutils literal notranslate"><span class="pre">utils.ner</span></code> module</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/reference/utils/ner.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="utils-ner-module">
<h1><code class="docutils literal notranslate"><span class="pre">utils.ner</span></code> module<a class="headerlink" href="#utils-ner-module" title="Permalink to this headline"></a></h1>
<dl class="py function">
<dt class="sig sig-object py" id="utils.ner.training_tokenize_and_align_labels">
<span class="sig-prename descclassname"><span class="pre">utils.ner.</span></span><span class="sig-name descname"><span class="pre">training_tokenize_and_align_labels</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">examples</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tokenizer</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">label_encoding_dict</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#utils.ner.training_tokenize_and_align_labels" title="Permalink to this definition"></a></dt>
<dd><p>During training, aligns tokens with labels.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>examples</strong> (<em>dict</em>) – One training instance (a dictioary with three keys: id, tokens, and ner_tags)</p></li>
<li><p><strong>tokenizer</strong> (<em>Tokenizer object</em>) – A transformers tokenizer object (the tokeniser of the base model).</p></li>
<li><p><strong>label_encoding_dict</strong> (<em>dict</em>) – The label2id mapping dictionary.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The tokenized input.</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>tokenized_inputs (Dataset object)</p>
</dd>
</dl>
<p class="rubric">Notes</p>
<p>Credit: This function is adapted from
<a class="reference external" href="https://github.com/huggingface/transformers/blob/main/examples/pytorch/token-classification/run_ner.py">https://github.com/huggingface/transformers/blob/main/examples/pytorch/token-classification/run_ner.py</a>.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="utils.ner.collect_named_entities">
<span class="sig-prename descclassname"><span class="pre">utils.ner.</span></span><span class="sig-name descname"><span class="pre">collect_named_entities</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tokens</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#utils.ner.collect_named_entities" title="Permalink to this definition"></a></dt>
<dd><p>Creates a list of Entity named-tuples, storing the entity
type and the start and end offsets of the entity.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>tokens</strong> (<em>list</em>) – a list of tags.</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>a list of Entity named-tuples</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>named_entities (list)</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="utils.ner.aggregate_mentions">
<span class="sig-prename descclassname"><span class="pre">utils.ner.</span></span><span class="sig-name descname"><span class="pre">aggregate_mentions</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">predictions</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">setting</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#utils.ner.aggregate_mentions" title="Permalink to this definition"></a></dt>
<dd><p>Aggregates mentions (NER outputs separate tokens) and finds
mention position in sentence.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>predictions</strong> – a list of lists (the outer list representing
a sentence, the inner list representing a token) representation
the NER predictions.</p></li>
<li><p><strong>setting</strong> – either “pred” or “gold”. If “pred”, set entity_link
to “O” (because we haven’t performed linking yet) and
perform average of the NER score of all the tokens that
belong to the same entity. If “gold”, set ner_score to
1.0 (it’s manually detected) and consolidate the link of the
mention subtokens.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><dl class="simple">
<dt>a list of dictionaries, there the list</dt><dd><p>corresponds to the sentence, and the inner dictionaries
correspond to the different (multi-token) mentions that
have been identified (in case of “pred”) or that were
annotated (in case of “gold”).</p>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>sent_mentions (list)</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="utils.ner.fix_capitalization">
<span class="sig-prename descclassname"><span class="pre">utils.ner.</span></span><span class="sig-name descname"><span class="pre">fix_capitalization</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">entity</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sentence</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#utils.ner.fix_capitalization" title="Permalink to this definition"></a></dt>
<dd><p>These entities are the output of the NER prediction, which returns
the processed word (uncapitalized, for example). We replace this
processed word by the true surface form in our original dataset
(using the character position information).</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>entity</strong> (<em>dict</em>) – A dictionary containing the prediction of one token.</p></li>
<li><p><strong>sentence</strong> (<em>str</em>) – The original sentence.</p></li>
</ul>
</dd>
</dl>
<dl class="simple">
<dt>Returns</dt><dd><p>newEntity (dict): The input dictionary, corrected re capitalisation.</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="utils.ner.fix_hyphens">
<span class="sig-prename descclassname"><span class="pre">utils.ner.</span></span><span class="sig-name descname"><span class="pre">fix_hyphens</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">lEntities</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#utils.ner.fix_hyphens" title="Permalink to this definition"></a></dt>
<dd><p>Fix B- and I- prefix assignment errors in hyphenated entities.
* Description: There is problem with grouping when there are hyphens in
words, e.g. “Ashton-under-Lyne” ([“Ashton”, “-”, “under”, “-”, “Lyne”])
is grouped as [“B-LOC”, “B-LOC”, “B-LOC”, “B-LOC”, “B-LOC”], when
it should be grouped as [“B-LOC”, “I-LOC”, “I-LOC”, “I-LOC”, “I-LOC”].
* Solution: if the current token or the previous token is a hyphen,
and the entity type of both previous and current token is the same
and not “O”, then change the current’s entity preffix to “I-“.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>lEntities</strong> (<em>list</em>) – List of dictionaries (corresponding to predicted tokens).</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><dl class="simple">
<dt>List of dictionaries with the corrected predictions</dt><dd><p>regarding hyphenation.</p>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>hyphEntities (list)</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="utils.ner.fix_nested">
<span class="sig-prename descclassname"><span class="pre">utils.ner.</span></span><span class="sig-name descname"><span class="pre">fix_nested</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">lEntities</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#utils.ner.fix_nested" title="Permalink to this definition"></a></dt>
<dd><p>Fix B- and I- prefix assignment errors in nested entities.
* Description: There is problem with grouping in nested entities,
e.g. “Island of Terceira” ([“Island”, “of”, “Terceira”])
is grouped as [“B-LOC”, “I-LOC”, “B-LOC”], when it should
be grouped as [“B-LOC”, “I-LOC”, “I-LOC”], as we consider
it one entity.
* Solution: if the current token or the previous token is a hyphen,
and the entity type of both previous and current token is  not “O”,
then change the current’s entity preffix to “I-“.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>lEntities</strong> (<em>list</em>) – List of dictionaries (corresponding to predicted tokens).</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><dl class="simple">
<dt>List of dictionaries with the corrected predictions</dt><dd><p>regarding nested entities.</p>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>nestEntities (list)</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="utils.ner.fix_startEntity">
<span class="sig-prename descclassname"><span class="pre">utils.ner.</span></span><span class="sig-name descname"><span class="pre">fix_startEntity</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">lEntities</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#utils.ner.fix_startEntity" title="Permalink to this definition"></a></dt>
<dd><p>Fix B- and I- prefix assignment errors:
* Case 1: The first token of a sentence can only be either</p>
<blockquote>
<div><p>O (i.e. not an entity) or B- (beginning of an
entity). There’s no way it should be I-. Fix
those.</p>
</div></blockquote>
<ul class="simple">
<li><dl class="simple">
<dt>Case 2: If the first token of a grouped entity is assigned</dt><dd><p>the prefix I-, change to B-. We know it’s the first
token in a grouped entity if the entity type of the
previous token is different.</p>
</dd>
</dl>
</li>
</ul>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>lEntities</strong> (<em>list</em>) – List of dictionaries (corresponding to predicted tokens).</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><dl class="simple">
<dt>List of dictionaries with the corrected predictions</dt><dd><p>regarding grouping of labels.</p>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>fixEntities (list)</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="utils.ner.aggregate_entities">
<span class="sig-prename descclassname"><span class="pre">utils.ner.</span></span><span class="sig-name descname"><span class="pre">aggregate_entities</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">entity</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">lEntities</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#utils.ner.aggregate_entities" title="Permalink to this definition"></a></dt>
<dd><p>If a word starts with ##, then this is a suffix, and word
should therefore be joined with previous detected entity.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>entity</strong> (<em>dict</em>) – A dictionary containing the current entity (predicted token).</p></li>
<li><p><strong>lEntities</strong> (<em>list</em>) – List of dictionaries (corresponding to all predicted tokens).</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><dl class="simple">
<dt>List of dictionaries with the corrected predictions</dt><dd><p>regarding split tokens.</p>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>lEntities (list)</p>
</dd>
</dl>
</dd></dl>

</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="get_data.html" class="btn btn-neutral float-left" title="utils.get_data module" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="preprocess_data.html" class="btn btn-neutral float-right" title="utils.preprocess_data module" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Federico Nanni.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>